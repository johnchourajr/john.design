{"version":3,"sources":["../../src/services/start-webpack-server.ts"],"names":["startWebpackServer","program","app","workerPool","store","report","panic","compiler","webpackActivity","websocketManager","cancelDevJSNotice","webpackWatching","suspend","hooks","invalid","tap","pendingActivity","id","watchRun","tapAsync","_","done","activityTimer","start","isFirstCompile","Promise","resolve","stats","messages","toJson","urls","https","host","proxyPort","isSuccessful","errors","length","sitePackageJson","name","open","localUrlForBrowser","console","log","chalk","yellow","Stage","Develop","compilation","panicOnBuild","end","state","getState","mapOfTemplatesToStaticQueryHashes","forEach","staticQueryHashes","componentPath","staticQueriesByTemplate","get","dispatch","type","payload","pages","components","emitter","emit"],"mappings":"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","sourcesContent":["import openurl from \"better-opn\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport formatWebpackMessages from \"react-dev-utils/formatWebpackMessages\"\nimport chalk from \"chalk\"\nimport { Compiler } from \"webpack\"\nimport { isEqual } from \"lodash\"\nimport { Stage } from \"../commands/types\"\n\nimport {\n  reportWebpackWarnings,\n  structureWebpackErrors,\n} from \"../utils/webpack-error-utils\"\n\nimport { printDeprecationWarnings } from \"../utils/print-deprecation-warnings\"\nimport { showExperimentNotices } from \"../utils/show-experiment-notice\"\nimport { printInstructions } from \"../utils/print-instructions\"\nimport { prepareUrls } from \"../utils/prepare-urls\"\nimport { startServer, IWebpackWatchingPauseResume } from \"../utils/start-server\"\nimport { WebsocketManager } from \"../utils/websocket-manager\"\nimport { IBuildContext } from \"./\"\nimport {\n  markWebpackStatusAsPending,\n  markWebpackStatusAsDone,\n} from \"../utils/webpack-status\"\nimport { enqueueFlush } from \"../utils/page-data\"\nimport mapTemplatesToStaticQueryHashes from \"../utils/map-templates-to-static-query-hashes\"\nimport { emitter } from \"../redux\"\n\nexport async function startWebpackServer({\n  program,\n  app,\n  workerPool,\n  store,\n}: Partial<IBuildContext>): Promise<{\n  compiler: Compiler\n  websocketManager: WebsocketManager\n  webpackWatching: IWebpackWatchingPauseResume\n}> {\n  if (!program || !app || !store) {\n    report.panic(`Missing required params`)\n  }\n  let {\n    compiler,\n    webpackActivity,\n    websocketManager,\n    cancelDevJSNotice,\n    webpackWatching,\n  } = await startServer(program, app, workerPool)\n  webpackWatching.suspend()\n\n  compiler.hooks.invalid.tap(`log compiling`, function () {\n    if (!webpackActivity) {\n      // mark webpack as pending if we are not in the middle of compilation already\n      // when input is invalidated during compilation, webpack will automatically\n      // run another compilation round before triggering `done` event\n      report.pendingActivity({ id: `webpack-develop` })\n      markWebpackStatusAsPending()\n    }\n  })\n\n  compiler.hooks.watchRun.tapAsync(`log compiling`, function (_, done) {\n    if (!webpackActivity) {\n      // there can be multiple `watchRun` events before receiving single `done` event\n      // webpack will not emit assets or `done` event until all pending invalidated\n      // inputs were compiled\n      webpackActivity = report.activityTimer(`Re-building development bundle`, {\n        id: `webpack-develop`,\n      })\n      webpackActivity.start()\n    }\n\n    done()\n  })\n\n  let isFirstCompile = true\n\n  return new Promise(resolve => {\n    compiler.hooks.done.tapAsync(`print gatsby instructions`, async function (\n      stats,\n      done\n    ) {\n      if (cancelDevJSNotice) {\n        cancelDevJSNotice()\n      }\n\n      // \"done\" event fires when Webpack has finished recompiling the bundle.\n      // Whether or not you have warnings or errors, you will get this event.\n\n      // We have switched off the default Webpack output in WebpackDevServer\n      // options so we are going to \"massage\" the warnings and errors and present\n      // them in a readable focused way.\n      const messages = formatWebpackMessages(stats.toJson({}, true))\n      const urls = prepareUrls(\n        program.https ? `https` : `http`,\n        program.host,\n        program.proxyPort\n      )\n      const isSuccessful = !messages.errors.length\n\n      if (isSuccessful && isFirstCompile) {\n        // Show notices to users about potential experiments/feature flags they could\n        // try.\n        showExperimentNotices()\n        printInstructions(\n          program.sitePackageJson.name || `(Unnamed package)`,\n          urls\n        )\n        printDeprecationWarnings()\n        if (program.open) {\n          try {\n            await openurl(urls.localUrlForBrowser)\n          } catch {\n            console.log(\n              `${chalk.yellow(\n                `warn`\n              )} Browser not opened because no browser was found`\n            )\n          }\n        }\n      }\n\n      isFirstCompile = false\n\n      if (webpackActivity) {\n        reportWebpackWarnings(stats)\n\n        if (!isSuccessful) {\n          const errors = structureWebpackErrors(\n            Stage.Develop,\n            stats.compilation.errors\n          )\n          webpackActivity.panicOnBuild(errors)\n        }\n        webpackActivity.end()\n        webpackActivity = null\n      }\n\n      if (isSuccessful) {\n        const state = store.getState()\n        const mapOfTemplatesToStaticQueryHashes = mapTemplatesToStaticQueryHashes(\n          state,\n          stats.compilation\n        )\n\n        mapOfTemplatesToStaticQueryHashes.forEach(\n          (staticQueryHashes, componentPath) => {\n            if (\n              !isEqual(\n                state.staticQueriesByTemplate.get(componentPath),\n                staticQueryHashes\n              )\n            ) {\n              store.dispatch({\n                type: `ADD_PENDING_TEMPLATE_DATA_WRITE`,\n                payload: {\n                  componentPath,\n                  pages: state.components.get(componentPath)?.pages ?? [],\n                },\n              })\n              store.dispatch({\n                type: `SET_STATIC_QUERIES_BY_TEMPLATE`,\n                payload: {\n                  componentPath,\n                  staticQueryHashes,\n                },\n              })\n            }\n          }\n        )\n\n        enqueueFlush()\n      }\n\n      markWebpackStatusAsDone()\n      done()\n      emitter.emit(`COMPILATION_DONE`, stats)\n      resolve({ compiler, websocketManager, webpackWatching })\n    })\n  })\n}\n"],"file":"start-webpack-server.js"}