{"version":3,"sources":["../../src/utils/gatsby-webpack-eslint-graphql-schema-reload-plugin.ts"],"names":["isEslintRule","rule","options","use","useEslintrc","GatsbyWebpackEslintGraphqlSchemaReload","constructor","plugin","name","schema","findEslintOptions","compiler","rules","module","find","Array","isArray","undefined","apply","hooks","compile","tap","program","store","getState","directory","Object","assign"],"mappings":";;;;;AAMA;;AACA;;AACA;;AAGA;;AAXA;AACA;AACA;AACA;AACA;AACA;AAQA,SAASA,YAAT,CAAsBC,IAAtB,EAAmD;AAAA;;AACjD,QAAMC,OAAO,GAAGD,IAAH,aAAGA,IAAH,oCAAGA,IAAI,CAAEE,GAAT,4DAAG,UAAY,CAAZ,CAAH,+CAAG,WAAgBD,OAAhC;AACA,SAAOA,OAAO,IAAI,OAAOA,OAAO,CAACE,WAAf,KAAgC,WAAlD;AACD;;AAEM,MAAMC,sCAAN,CAA6C;AAIlDC,EAAAA,WAAW,GAAG;AACZ,SAAKC,MAAL,GAAc;AAAEC,MAAAA,IAAI,EAAG;AAAT,KAAd;AACA,SAAKC,MAAL,GAAc,IAAd;AACD;;AAEDC,EAAAA,iBAAiB,CAACC,QAAD,EAA+C;AAAA;;AAC9D,UAAMC,KAAK,4BAAGD,QAAQ,CAACT,OAAT,CAAiBW,MAApB,oFAAG,sBAAyBD,KAAzB,CAA+BE,IAA/B,CAAoCd,YAApC,CAAH,2DAAG,uBAAmDG,GAAjE;AACA,UAAMF,IAAI,GAAGc,KAAK,CAACC,OAAN,CAAcJ,KAAd,IAAuBA,KAAK,CAAC,CAAD,CAA5B,GAAkCA,KAA/C;AACA,WAAO,OAAOX,IAAP,KAAiB,QAAjB,GAA2BA,IAA3B,aAA2BA,IAA3B,uBAA2BA,IAAI,CAAEC,OAAjC,GAA2Ce,SAAlD;AACD;;AAEDC,EAAAA,KAAK,CAACP,QAAD,EAA2B;AAC9BA,IAAAA,QAAQ,CAACQ,KAAT,CAAeC,OAAf,CAAuBC,GAAvB,CAA2B,KAAKd,MAAL,CAAYC,IAAvC,EAA6C,MAAM;AACjD,YAAM;AAAEC,QAAAA,MAAF;AAAUa,QAAAA;AAAV,UAAsBC,aAAMC,QAAN,EAA5B;;AAEA,UAAI,CAAC,KAAKf,MAAV,EAAkB;AAChB;AACA,aAAKA,MAAL,GAAcA,MAAd;AACA;AACD;;AAED,UAAI,KAAKA,MAAL,KAAgBA,MAAhB,IAA0B,6CAAea,OAAO,CAACG,SAAvB,CAA9B,EAAiE;AAC/D;AACD;;AACD,WAAKhB,MAAL,GAAcA,MAAd,CAZiD,CAcjD;;AACA,YAAMP,OAAO,GAAG,KAAKQ,iBAAL,CAAuBC,QAAvB,CAAhB;;AAEA,UAAI,CAACT,OAAL,EAAc;AACZ;AACD,OAnBgD,CAqBjD;AACA;;;AACAwB,MAAAA,MAAM,CAACC,MAAP,CAAczB,OAAd,EAAuB,gCAAaO,MAAb,EAAqB,uCAArB,CAAvB;AACD,KAxBD;AAyBD;;AAzCiD","sourcesContent":["/**\n * The problem: after GraphQL schema rebuilds, eslint loader keeps validating against\n * the old schema.\n *\n * This plugin replaces options of eslint-plugin-graphql during develop\n */\nimport { store } from \"../redux\"\nimport { eslintConfig } from \"./eslint-config\"\nimport { hasLocalEslint } from \"./local-eslint-config-finder\"\nimport { RuleSetRule, Compiler, RuleSetQuery } from \"webpack\"\nimport { GraphQLSchema } from \"graphql\"\nimport { reactHasJsxRuntime } from \"./webpack-utils\"\n\nfunction isEslintRule(rule?: RuleSetRule): boolean {\n  const options = rule?.use?.[0]?.options\n  return options && typeof options.useEslintrc !== `undefined`\n}\n\nexport class GatsbyWebpackEslintGraphqlSchemaReload {\n  private plugin: { name: string }\n  private schema: GraphQLSchema | null\n\n  constructor() {\n    this.plugin = { name: `GatsbyWebpackEslintGraphqlSchemaReload` }\n    this.schema = null\n  }\n\n  findEslintOptions(compiler: Compiler): RuleSetQuery | undefined {\n    const rules = compiler.options.module?.rules.find(isEslintRule)?.use\n    const rule = Array.isArray(rules) ? rules[0] : rules\n    return typeof rule === `object` ? rule?.options : undefined\n  }\n\n  apply(compiler: Compiler): void {\n    compiler.hooks.compile.tap(this.plugin.name, () => {\n      const { schema, program } = store.getState()\n\n      if (!this.schema) {\n        // initial build\n        this.schema = schema\n        return\n      }\n\n      if (this.schema === schema || hasLocalEslint(program.directory)) {\n        return\n      }\n      this.schema = schema\n\n      // Original eslint config object from webpack rules\n      const options = this.findEslintOptions(compiler)\n\n      if (!options) {\n        return\n      }\n\n      // Hackish but works:\n      // replacing original eslint options object with updated config\n      Object.assign(options, eslintConfig(schema, reactHasJsxRuntime()))\n    })\n  }\n}\n"],"file":"gatsby-webpack-eslint-graphql-schema-reload-plugin.js"}