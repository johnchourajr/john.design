{"version":3,"sources":["../../src/utils/start-server.ts"],"names":["startServer","program","app","workerPool","WorkerPool","create","directory","webpackActivity","report","activityTimer","id","start","THIRTY_SECONDS","cancelDevJSNotice","process","env","gatsby_executing_command","GATSBY_EXPERIMENTAL_PRESERVE_WEBPACK_CACHE","directoryPath","buildHTML","require","createIndexHtml","activity","stage","Stage","DevelopHTML","pagePaths","err","name","panic","stripIndent","indexHTMLActivity","phantomActivity","GATSBY_EXPERIMENTAL_DEV_SSR","buildRenderer","initDevWorkerPool","end","devConfig","port","parentSpan","span","compiler","use","telemetry","expressMiddleware","log","path","heartbeat","graphqlEndpoint","GATSBY_GRAPHQL_IDE","get","endpoint","schema","schemaCustomization","store","getState","composer","Error","graphiql","extensions","enableRefresh","ENABLE_GATSBY_REFRESH_ENDPOINT","refreshToken","GATSBY_REFRESH_TOKEN","context","schemaComposer","customContext","customFormatErrorFn","stack","split","REFRESH_ENDPOINT","refresh","req","pluginName","emitter","emit","webhookBody","body","post","express","json","res","params","authorizedRefresh","headers","authorization","status","setHeader","error","isEnabled","query","fileName","lineNumber","next","requestedPagePath","pagePath","potentialPagePath","page","pageData","GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND","Date","now","trackCli","duration","join","send","e","index","webpackDevMiddlewareInstance","logLevel","publicPath","output","watchOptions","devServer","stats","serverSideRender","webpackStats","compilation","modules","locals","emptyResponse","codeFrame","sourcePosition","sourceContent","moduleId","parseInt","columnNumber","fileModule","find","m","sourceMap","_source","_sourceMap","position","line","column","result","sourceLine","sourceColumn","highlightCode","developMiddleware","config","proxy","forEach","prefix","url","proxiedUrl","originalUrl","host","method","pipe","got","stream","decompress","on","response","writeHead","statusCode","_","message","sendStatus","deferNodeMutation","route","GATSBY_QUERY_ON_DEMAND_LOADING_INDICATOR","fullUrl","protocol","endsWith","webpackCompilationHash","renderDevHTML","renderResponse","undefined","htmlComponentRendererPath","sendFile","server","http","Server","socket","websocketManager","init","listener","listen","chokidar","slash","watchGlobs","map","watch","to","webpackWatching","watching"],"mappings":"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","sourcesContent":["import webpackHotMiddleware from \"webpack-hot-middleware\"\nimport webpackDevMiddleware, {\n  WebpackDevMiddleware,\n} from \"webpack-dev-middleware\"\nimport got from \"got\"\nimport webpack from \"webpack\"\nimport express from \"express\"\nimport compression from \"compression\"\nimport graphqlHTTP from \"express-graphql\"\nimport graphqlPlayground from \"graphql-playground-middleware-express\"\nimport graphiqlExplorer from \"gatsby-graphiql-explorer\"\nimport { formatError } from \"graphql\"\nimport { isCI } from \"gatsby-core-utils\"\nimport http from \"http\"\nimport https from \"https\"\nimport cors from \"cors\"\nimport telemetry from \"gatsby-telemetry\"\nimport launchEditor from \"react-dev-utils/launchEditor\"\nimport { codeFrameColumns } from \"@babel/code-frame\"\n\nimport { withBasePath } from \"../utils/path\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { store, emitter } from \"../redux\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport * as WorkerPool from \"../utils/worker/pool\"\n\nimport { developStatic } from \"../commands/develop-static\"\nimport withResolverContext from \"../schema/context\"\nimport { websocketManager, WebsocketManager } from \"../utils/websocket-manager\"\nimport {\n  showExperimentNoticeAfterTimeout,\n  CancelExperimentNoticeCallbackOrUndefined,\n} from \"../utils/show-experiment-notice\"\nimport {\n  reverseFixedPagePath,\n  readPageData,\n  IPageDataWithQueryResult,\n} from \"./page-data\"\nimport { getPageData as getPageDataExperimental } from \"./get-page-data\"\nimport { findPageByPath } from \"./find-page-by-path\"\nimport apiRunnerNode from \"../utils/api-runner-node\"\nimport { Express } from \"express\"\nimport * as path from \"path\"\n\nimport { Stage, IProgram } from \"../commands/types\"\nimport JestWorker from \"jest-worker\"\nimport { findOriginalSourcePositionAndContent } from \"./stack-trace-utils\"\nimport { appendPreloadHeaders } from \"./develop-preload-headers\"\nimport {\n  routeLoadingIndicatorRequests,\n  writeVirtualLoadingIndicatorModule,\n} from \"./loading-indicator\"\n\ntype ActivityTracker = any // TODO: Replace this with proper type once reporter is typed\n\ninterface IServer {\n  compiler: webpack.Compiler\n  listener: http.Server | https.Server\n  webpackActivity: ActivityTracker\n  cancelDevJSNotice: CancelExperimentNoticeCallbackOrUndefined\n  websocketManager: WebsocketManager\n  workerPool: JestWorker\n  webpackWatching: IWebpackWatchingPauseResume\n}\n\nexport interface IWebpackWatchingPauseResume extends webpack.Watching {\n  suspend: () => void\n  resume: () => void\n}\n\n// context seems to be public, but not documented API\n// see https://github.com/webpack/webpack-dev-middleware/issues/656\ntype PatchedWebpackDevMiddleware = WebpackDevMiddleware &\n  express.RequestHandler & {\n    context: {\n      watching: IWebpackWatchingPauseResume\n    }\n  }\n\nexport async function startServer(\n  program: IProgram,\n  app: Express,\n  workerPool: JestWorker = WorkerPool.create()\n): Promise<IServer> {\n  const directory = program.directory\n\n  const webpackActivity = report.activityTimer(`Building development bundle`, {\n    id: `webpack-develop`,\n  })\n  webpackActivity.start()\n\n  const THIRTY_SECONDS = 30 * 1000\n  let cancelDevJSNotice: CancelExperimentNoticeCallbackOrUndefined\n  if (\n    process.env.gatsby_executing_command === `develop` &&\n    !process.env.GATSBY_EXPERIMENTAL_PRESERVE_WEBPACK_CACHE &&\n    !isCI()\n  ) {\n    cancelDevJSNotice = showExperimentNoticeAfterTimeout(\n      `Preserve webpack's Cache`,\n      `https://github.com/gatsbyjs/gatsby/discussions/28331`,\n      `which changes Gatsby's cache clearing behavior to not clear webpack's\ncache unless you run \"gatsby clean\" or delete the .cache folder manually.\nHere's how to try it:\n\nmodule.exports = {\n  flags: { PRESERVE_WEBPACK_CACHE: true },\n  plugins: [...]\n}`,\n      THIRTY_SECONDS\n    )\n  }\n\n  // Remove the following when merging GATSBY_EXPERIMENTAL_DEV_SSR\n  const directoryPath = withBasePath(directory)\n  const { buildHTML } = require(`../commands/build-html`)\n  const createIndexHtml = async (activity: ActivityTracker): Promise<void> => {\n    try {\n      await buildHTML({\n        program,\n        stage: Stage.DevelopHTML,\n        pagePaths: [`/`],\n        workerPool,\n        activity,\n      })\n    } catch (err) {\n      if (err.name !== `WebpackError`) {\n        report.panic(err)\n        return\n      }\n      report.panic(\n        report.stripIndent`\n          There was an error compiling the html.js component for the development server.\n          See our docs page on debugging HTML builds for help https://gatsby.dev/debug-html\n        `,\n        err\n      )\n    }\n  }\n  const indexHTMLActivity = report.phantomActivity(`building index.html`, {})\n\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    const { buildRenderer } = require(`../commands/build-html`)\n    await buildRenderer(program, Stage.DevelopHTML)\n    const { initDevWorkerPool } = require(`./dev-ssr/render-dev-html`)\n    initDevWorkerPool()\n  } else {\n    indexHTMLActivity.start()\n\n    await createIndexHtml(indexHTMLActivity)\n\n    indexHTMLActivity.end()\n  }\n\n  const devConfig = await webpackConfig(\n    program,\n    directory,\n    `develop`,\n    program.port,\n    { parentSpan: webpackActivity.span }\n  )\n\n  const compiler = webpack(devConfig)\n\n  /**\n   * Set up the express app.\n   **/\n  app.use(compression())\n  app.use(telemetry.expressMiddleware(`DEVELOP`))\n  app.use(\n    webpackHotMiddleware(compiler, {\n      log: false,\n      path: `/__webpack_hmr`,\n      heartbeat: 10 * 1000,\n    })\n  )\n\n  app.use(cors())\n\n  /**\n   * Pattern matching all endpoints with graphql or graphiql with 1 or more leading underscores\n   */\n  const graphqlEndpoint = `/_+graphi?ql`\n\n  if (process.env.GATSBY_GRAPHQL_IDE === `playground`) {\n    app.get(\n      graphqlEndpoint,\n      graphqlPlayground({\n        endpoint: `/___graphql`,\n      }),\n      () => {}\n    )\n  } else {\n    graphiqlExplorer(app, {\n      graphqlEndpoint,\n    })\n  }\n\n  app.use(\n    graphqlEndpoint,\n    graphqlHTTP(\n      (): graphqlHTTP.OptionsData => {\n        const { schema, schemaCustomization } = store.getState()\n\n        if (!schemaCustomization.composer) {\n          throw new Error(\n            `A schema composer was not created in time. This is likely a gatsby bug. If you experienced this please create an issue.`\n          )\n        }\n        return {\n          schema,\n          graphiql: false,\n          extensions(): { [key: string]: unknown } {\n            return {\n              enableRefresh: process.env.ENABLE_GATSBY_REFRESH_ENDPOINT,\n              refreshToken: process.env.GATSBY_REFRESH_TOKEN,\n            }\n          },\n          context: withResolverContext({\n            schema,\n            schemaComposer: schemaCustomization.composer,\n            context: {},\n            customContext: schemaCustomization.context,\n          }),\n          customFormatErrorFn(err): unknown {\n            return {\n              ...formatError(err),\n              stack: err.stack ? err.stack.split(`\\n`) : [],\n            }\n          },\n        }\n      }\n    )\n  )\n\n  /**\n   * Refresh external data sources.\n   * This behavior is disabled by default, but the ENABLE_GATSBY_REFRESH_ENDPOINT env var enables it\n   * If no GATSBY_REFRESH_TOKEN env var is available, then no Authorization header is required\n   **/\n  const REFRESH_ENDPOINT = `/__refresh`\n  const refresh = async (\n    req: express.Request,\n    pluginName?: string\n  ): Promise<void> => {\n    emitter.emit(`WEBHOOK_RECEIVED`, {\n      webhookBody: req.body,\n      pluginName,\n    })\n  }\n\n  app.post(`${REFRESH_ENDPOINT}/:plugin_name?`, express.json(), (req, res) => {\n    const pluginName = req.params[`plugin_name`]\n\n    const enableRefresh = process.env.ENABLE_GATSBY_REFRESH_ENDPOINT\n    const refreshToken = process.env.GATSBY_REFRESH_TOKEN\n    const authorizedRefresh =\n      !refreshToken || req.headers.authorization === refreshToken\n\n    if (enableRefresh && authorizedRefresh) {\n      refresh(req, pluginName)\n      res.status(200)\n      res.setHeader(`content-type`, `application/json`)\n    } else {\n      res.status(authorizedRefresh ? 404 : 403)\n      res.json({\n        error: enableRefresh\n          ? `Authorization failed. Make sure you add authorization header to your refresh requests`\n          : `Refresh endpoint is not enabled. Run gatsby with \"ENABLE_GATSBY_REFRESH_ENDPOINT=true\" environment variable set.`,\n        isEnabled: !!process.env.ENABLE_GATSBY_REFRESH_ENDPOINT,\n      })\n    }\n    res.end()\n  })\n\n  app.get(`/__open-stack-frame-in-editor`, (req, res) => {\n    launchEditor(req.query.fileName, req.query.lineNumber)\n    res.end()\n  })\n\n  app.get(\n    `/page-data/:pagePath(*)/page-data.json`,\n    async (req, res, next): Promise<void> => {\n      const requestedPagePath = req.params.pagePath\n      if (!requestedPagePath) {\n        next()\n        return\n      }\n\n      const potentialPagePath = reverseFixedPagePath(requestedPagePath)\n      const page = findPageByPath(store.getState(), potentialPagePath, false)\n\n      if (page) {\n        try {\n          let pageData: IPageDataWithQueryResult\n          if (process.env.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND) {\n            const start = Date.now()\n\n            pageData = await getPageDataExperimental(page.path)\n\n            telemetry.trackCli(`RUN_QUERY_ON_DEMAND`, {\n              name: `getPageData`,\n              duration: Date.now() - start,\n            })\n          } else {\n            pageData = await readPageData(\n              path.join(store.getState().program.directory, `public`),\n              page.path\n            )\n          }\n\n          res.status(200).send(pageData)\n          return\n        } catch (e) {\n          report.error(\n            `Error loading a result for the page query in \"${requestedPagePath}\" / \"${potentialPagePath}\". Query was not run and no cached result was found.`,\n            e\n          )\n        }\n      }\n\n      res.status(404).send({\n        path: potentialPagePath,\n      })\n    }\n  )\n\n  // Disable directory indexing i.e. serving index.html from a directory.\n  // This can lead to serving stale html files during development.\n  //\n  // We serve by default an empty index.html that sets up the dev environment.\n  app.use(developStatic(`public`, { index: false }))\n\n  const webpackDevMiddlewareInstance = (webpackDevMiddleware(compiler, {\n    logLevel: `silent`,\n    publicPath: devConfig.output.publicPath,\n    watchOptions: devConfig.devServer ? devConfig.devServer.watchOptions : null,\n    stats: `errors-only`,\n    serverSideRender: true,\n  }) as unknown) as PatchedWebpackDevMiddleware\n\n  app.use(webpackDevMiddlewareInstance)\n\n  app.get(`/__original-stack-frame`, async (req, res) => {\n    const {\n      webpackStats: {\n        compilation: { modules },\n      },\n    } = res.locals\n    const emptyResponse = {\n      codeFrame: `No codeFrame could be generated`,\n      sourcePosition: null,\n      sourceContent: null,\n    }\n\n    const moduleId = req?.query?.moduleId\n    const lineNumber = parseInt(req.query.lineNumber, 10)\n    const columnNumber = parseInt(req.query.columnNumber, 10)\n\n    const fileModule = modules.find(m => m.id === moduleId)\n    const sourceMap = fileModule?._source?._sourceMap\n\n    if (!sourceMap) {\n      res.json(emptyResponse)\n      return\n    }\n\n    const position = { line: lineNumber, column: columnNumber }\n    const result = await findOriginalSourcePositionAndContent(\n      sourceMap,\n      position\n    )\n\n    const sourcePosition = result?.sourcePosition\n    const sourceLine = sourcePosition?.line\n    const sourceColumn = sourcePosition?.column\n    const sourceContent = result?.sourceContent\n\n    if (!sourceContent || !sourceLine) {\n      res.json(emptyResponse)\n      return\n    }\n\n    const codeFrame = codeFrameColumns(\n      sourceContent,\n      {\n        start: {\n          line: sourceLine,\n          column: sourceColumn ?? 0,\n        },\n      },\n      {\n        highlightCode: true,\n      }\n    )\n    res.json({\n      codeFrame,\n      sourcePosition,\n      sourceContent,\n    })\n  })\n\n  // Expose access to app for advanced use cases\n  const { developMiddleware } = store.getState().config\n\n  if (developMiddleware) {\n    developMiddleware(app, program)\n  }\n\n  // Set up API proxy.\n  const { proxy } = store.getState().config\n  if (proxy) {\n    proxy.forEach(({ prefix, url }) => {\n      app.use(`${prefix}/*`, (req, res) => {\n        const proxiedUrl = url + req.originalUrl\n        const {\n          // remove `host` from copied headers\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\n          headers: { host, ...headers },\n          method,\n        } = req\n        req\n          .pipe(\n            got\n              .stream(proxiedUrl, { headers, method, decompress: false })\n              .on(`response`, response =>\n                res.writeHead(response.statusCode || 200, response.headers)\n              )\n              .on(`error`, (err, _, response) => {\n                if (response) {\n                  res.writeHead(response.statusCode || 400, response.headers)\n                } else {\n                  const message = `Error when trying to proxy request \"${req.originalUrl}\" to \"${proxiedUrl}\"`\n\n                  report.error(message, err)\n                  res.sendStatus(500)\n                }\n              })\n          )\n          .pipe(res)\n      })\n    }, cors())\n  }\n\n  await apiRunnerNode(`onCreateDevServer`, { app, deferNodeMutation: true })\n\n  // In case nothing before handled hot-update - send 404.\n  // This fixes \"Unexpected token < in JSON at position 0\" runtime\n  // errors after restarting development server and\n  // cause automatic hard refresh in the browser.\n  app.use(/.*\\.hot-update\\.json$/i, (_, res) => {\n    res.status(404).end()\n  })\n\n  // Render an HTML page and serve it.\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    // Setup HTML route.\n    const { route } = require(`./dev-ssr/develop-html-route`)\n    route({ app, program, store })\n  }\n\n  // loading indicator\n  // write virtual module always to not fail webpack compilation, but only add express route handlers when\n  // query on demand is enabled and loading indicator is not disabled\n  writeVirtualLoadingIndicatorModule()\n  if (\n    process.env.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND &&\n    process.env.GATSBY_QUERY_ON_DEMAND_LOADING_INDICATOR === `true`\n  ) {\n    routeLoadingIndicatorRequests(app)\n  }\n\n  app.use(async (req, res) => {\n    // in this catch-all block we don't support POST so we should 404\n    if (req.method === `POST`) {\n      res.status(404).end()\n      return\n    }\n\n    const fullUrl = req.protocol + `://` + req.get(`host`) + req.originalUrl\n    // This isn't used in development.\n    if (fullUrl.endsWith(`app-data.json`)) {\n      res.json({ webpackCompilationHash: `123` })\n      // If this gets here, it's a non-existant file so just send back 404.\n    } else if (fullUrl.endsWith(`.json`)) {\n      res.json({}).status(404)\n    } else {\n      await appendPreloadHeaders(req.path, res)\n\n      if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n        try {\n          const { renderDevHTML } = require(`./dev-ssr/render-dev-html`)\n          const renderResponse = await renderDevHTML({\n            path: `/dev-404-page/`,\n            // Let renderDevHTML figure it out.\n            page: undefined,\n            store,\n            htmlComponentRendererPath: `${program.directory}/public/render-page.js`,\n            directory: program.directory,\n          })\n          const status = process.env.GATSBY_EXPERIMENTAL_DEV_SSR ? 404 : 200\n          res.status(status).send(renderResponse)\n        } catch (e) {\n          report.error(e)\n          res.send(e).status(500)\n        }\n      } else {\n        res.sendFile(directoryPath(`public/index.html`), err => {\n          if (err) {\n            res.status(500).end()\n          }\n        })\n      }\n    }\n  })\n\n  /**\n   * Set up the HTTP server and socket.io.\n   **/\n  const server = new http.Server(app)\n\n  const socket = websocketManager.init({ server })\n\n  // hardcoded `localhost`, because host should match `target` we set\n  // in http proxy in `develop-proxy`\n  const listener = server.listen(program.port, `localhost`)\n\n  if (!process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    const chokidar = require(`chokidar`)\n    const { slash } = require(`gatsby-core-utils`)\n    // Register watcher that rebuilds index.html every time html.js changes.\n    const watchGlobs = [`src/html.js`, `plugins/**/gatsby-ssr.js`].map(path =>\n      slash(directoryPath(path))\n    )\n\n    chokidar.watch(watchGlobs).on(`change`, async () => {\n      await createIndexHtml(indexHTMLActivity)\n      // eslint-disable-next-line no-unused-expressions\n      socket?.to(`clients`).emit(`reload`)\n    })\n  }\n\n  return {\n    compiler,\n    listener,\n    webpackActivity,\n    cancelDevJSNotice,\n    websocketManager,\n    workerPool,\n    webpackWatching: webpackDevMiddlewareInstance.context.watching,\n  }\n}\n"],"file":"start-server.js"}