{"version":3,"sources":["../../src/query/query-runner.ts"],"names":["resultHashes","Map","reportLongRunningQueryJob","queryJob","messageParts","componentPath","isPage","path","context","push","_","isEmpty","JSON","stringify","report","warn","join","panicQueryJobError","errors","urlPath","undefined","queryContext","plugin","pluginCreatorId","structuredErrors","map","e","structuredError","message","filePath","location","codeFrame","query","locations","line","column","panicOnBuild","startQueryJob","graphqlRunner","parentSpan","isPending","timeoutId","setTimeout","queryName","id","clearTimeout","queryRunner","program","store","getState","boundActionCreators","queryStart","result","Object","assign","pageContext","internalComponentName","component","componentChunkName","updatedAt","pluginCreator___NODE","isCreatedByStatefulCreatePages","resultJSON","resultHash","crypto","createHash","update","digest","get","directory","set","resultPath","replace","fs","outputFile","dispatch","type","payload","hash","pageQueryRun","process","env","GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES","setPageData"],"mappings":"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","sourcesContent":["import { Span } from \"opentracing\"\nimport _ from \"lodash\"\nimport fs from \"fs-extra\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport crypto from \"crypto\"\nimport { ExecutionResult, GraphQLError } from \"graphql\"\n\nimport path from \"path\"\nimport { store } from \"../redux\"\nimport { boundActionCreators } from \"../redux/actions\"\nimport { getCodeFrame } from \"./graphql-errors\"\nimport errorParser from \"./error-parser\"\n\nimport { GraphQLRunner } from \"./graphql-runner\"\nimport { IExecutionResult, PageContext } from \"./types\"\nimport { pageDataExists } from \"../utils/page-data\"\n\nconst resultHashes = new Map()\n\ninterface IQueryJob {\n  id: string\n  hash?: string\n  query: string\n  componentPath: string\n  context: PageContext\n  isPage: boolean\n  pluginCreatorId: string\n}\n\nfunction reportLongRunningQueryJob(queryJob): void {\n  const messageParts = [\n    `Query takes too long:`,\n    `File path: ${queryJob.componentPath}`,\n  ]\n\n  if (queryJob.isPage) {\n    const { path, context } = queryJob.context\n    messageParts.push(`URL path: ${path}`)\n\n    if (!_.isEmpty(context)) {\n      messageParts.push(`Context: ${JSON.stringify(context, null, 4)}`)\n    }\n  }\n\n  report.warn(messageParts.join(`\\n`))\n}\n\nfunction panicQueryJobError(\n  queryJob: IQueryJob,\n  errors: ReadonlyArray<GraphQLError>\n): void {\n  let urlPath = undefined\n  let queryContext = {}\n  const plugin = queryJob.pluginCreatorId || `none`\n\n  if (queryJob.isPage) {\n    urlPath = queryJob.context.path\n    queryContext = queryJob.context.context\n  }\n\n  const structuredErrors = errors.map(e => {\n    const structuredError = errorParser({\n      message: e.message,\n      filePath: undefined,\n      location: undefined,\n    })\n\n    structuredError.context = {\n      ...structuredError.context,\n      codeFrame: getCodeFrame(\n        queryJob.query,\n        e.locations && e.locations[0].line,\n        e.locations && e.locations[0].column\n      ),\n      filePath: queryJob.componentPath,\n      ...(urlPath ? { urlPath } : {}),\n      ...queryContext,\n      plugin,\n    }\n\n    return structuredError\n  })\n\n  report.panicOnBuild(structuredErrors)\n}\n\nasync function startQueryJob(\n  graphqlRunner: GraphQLRunner,\n  queryJob: IQueryJob,\n  parentSpan: Span | undefined\n): Promise<ExecutionResult> {\n  let isPending = true\n\n  // Print out warning when query takes too long\n  const timeoutId = setTimeout(() => {\n    if (isPending) {\n      reportLongRunningQueryJob(queryJob)\n    }\n  }, 15000)\n\n  try {\n    return await graphqlRunner.query(queryJob.query, queryJob.context, {\n      parentSpan,\n      queryName: queryJob.id,\n    })\n  } finally {\n    isPending = false\n    clearTimeout(timeoutId)\n  }\n}\n\nexport async function queryRunner(\n  graphqlRunner: GraphQLRunner,\n  queryJob: IQueryJob,\n  parentSpan: Span | undefined\n): Promise<IExecutionResult> {\n  const { program } = store.getState()\n\n  boundActionCreators.queryStart({\n    path: queryJob.id,\n    componentPath: queryJob.componentPath,\n    isPage: queryJob.isPage,\n  })\n\n  // Run query\n  let result: IExecutionResult\n  // Nothing to do if the query doesn't exist.\n  if (!queryJob.query || queryJob.query === ``) {\n    result = {}\n  } else {\n    result = await startQueryJob(graphqlRunner, queryJob, parentSpan)\n  }\n\n  if (result.errors) {\n    // If there's a graphql error then log the error and exit\n    panicQueryJobError(queryJob, result.errors)\n  }\n\n  // Add the page context onto the results.\n  if (queryJob && queryJob.isPage) {\n    result[`pageContext`] = Object.assign({}, queryJob.context)\n  }\n\n  // Delete internal data from pageContext\n  if (result.pageContext) {\n    delete result.pageContext.path\n    delete result.pageContext.internalComponentName\n    delete result.pageContext.component\n    delete result.pageContext.componentChunkName\n    delete result.pageContext.updatedAt\n    delete result.pageContext.pluginCreator___NODE\n    delete result.pageContext.pluginCreatorId\n    delete result.pageContext.componentPath\n    delete result.pageContext.context\n    delete result.pageContext.isCreatedByStatefulCreatePages\n  }\n\n  const resultJSON = JSON.stringify(result)\n  const resultHash = crypto\n    .createHash(`sha1`)\n    .update(resultJSON)\n    .digest(`base64`)\n\n  if (\n    resultHash !== resultHashes.get(queryJob.id) ||\n    (queryJob.isPage &&\n      !pageDataExists(path.join(program.directory, `public`), queryJob.id))\n  ) {\n    resultHashes.set(queryJob.id, resultHash)\n\n    if (queryJob.isPage) {\n      // We need to save this temporarily in cache because\n      // this might be incomplete at the moment\n      const resultPath = path.join(\n        program.directory,\n        `.cache`,\n        `json`,\n        `${queryJob.id.replace(/\\//g, `_`)}.json`\n      )\n      await fs.outputFile(resultPath, resultJSON)\n      store.dispatch({\n        type: `ADD_PENDING_PAGE_DATA_WRITE`,\n        payload: {\n          path: queryJob.id,\n        },\n      })\n    } else {\n      const resultPath = path.join(\n        program.directory,\n        `public`,\n        `page-data`,\n        `sq`,\n        `d`,\n        `${queryJob.hash}.json`\n      )\n      await fs.outputFile(resultPath, resultJSON)\n    }\n  }\n\n  // Broadcast that a page's query has run.\n  boundActionCreators.pageQueryRun({\n    path: queryJob.id,\n    componentPath: queryJob.componentPath,\n    isPage: queryJob.isPage,\n  })\n\n  // Sets pageData to the store, here for easier access to the resultHash\n  if (\n    process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES &&\n    queryJob.isPage\n  ) {\n    boundActionCreators.setPageData({\n      id: queryJob.id,\n      resultHash,\n    })\n  }\n  return result\n}\n"],"file":"query-runner.js"}