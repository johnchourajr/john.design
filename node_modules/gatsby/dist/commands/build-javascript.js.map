{"version":3,"sources":["../../src/commands/build-javascript.ts"],"names":["buildProductionBundle","program","parentSpan","directory","compilerConfig","Promise","resolve","reject","compiler","hooks","compilation","tap","compilationCompiler","parentCompilation","seal","state","store","getState","mapOfTemplatesToStaticQueryHashes","forEach","staticQueryHashes","componentPath","staticQueriesByTemplate","get","dispatch","type","payload","pages","components","run","err","stats","hasErrors","flattenStatsErrors","errors","children","child","getStats"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AAIA;;AAMO,MAAMA,qBAAqB,GAAG,OACnCC,OADmC,EAEnCC,UAFmC,KAGR;AAC3B,QAAM;AAAEC,IAAAA;AAAF,MAAgBF,OAAtB;AAEA,QAAMG,cAAc,GAAG,MAAM,uBAC3BH,OAD2B,EAE3BE,SAF2B,EAG1B,kBAH0B,EAI3B,IAJ2B,EAK3B;AAAED,IAAAA;AAAF,GAL2B,CAA7B;AAQA,SAAO,IAAIG,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,UAAMC,QAAQ,GAAG,sBAAQJ,cAAR,CAAjB;AAEAI,IAAAA,QAAQ,CAACC,KAAT,CAAeC,WAAf,CAA2BC,GAA3B,CAAgC,yBAAhC,EAA0DD,WAAW,IAAI;AACvE;AACA;AACA;AACA;AACA,YAAME,mBAA0D,GAC9DF,WAAW,CAACF,QADd;;AAEA,UAAII,mBAAmB,CAACC,iBAAxB,EAA2C;AACzC;AACD;;AAEDH,MAAAA,WAAW,CAACD,KAAZ,CAAkBK,IAAlB,CAAuBH,GAAvB,CAA4B,yBAA5B,EAAsD,MAAM;AAC1D,cAAMI,KAAK,GAAGC,aAAMC,QAAN,EAAd;;AACA,cAAMC,iCAAiC,GAAG,8CACxCH,KADwC,EAExCL,WAFwC,CAA1C;AAKAQ,QAAAA,iCAAiC,CAACC,OAAlC,CACE,CAACC,iBAAD,EAAoBC,aAApB,KAAsC;AACpC,cACE,CAAC,qBACCN,KAAK,CAACO,uBAAN,CAA8BC,GAA9B,CAAkCF,aAAlC,CADD,EAECD,iBAFD,CADH,EAKE;AAAA;;AACAJ,yBAAMQ,QAAN,CAAe;AACbC,cAAAA,IAAI,EAAG,iCADM;AAEbC,cAAAA,OAAO,EAAE;AACPL,gBAAAA,aADO;AAEPM,gBAAAA,KAAK,qDAAEZ,KAAK,CAACa,UAAN,CAAiBL,GAAjB,CAAqBF,aAArB,CAAF,2DAAE,uBAAqCM,KAAvC,yEAAgD;AAF9C;AAFI,aAAf;;AAOAX,yBAAMQ,QAAN,CAAe;AACbC,cAAAA,IAAI,EAAG,gCADM;AAEbC,cAAAA,OAAO,EAAE;AACPL,gBAAAA,aADO;AAEPD,gBAAAA;AAFO;AAFI,aAAf;AAOD;AACF,SAvBH;AAyBD,OAhCD;AAiCD,KA5CD;AA8CAZ,IAAAA,QAAQ,CAACqB,GAAT,CAAa,CAACC,GAAD,EAAMC,KAAN,KAAgB;AAC3B,UAAID,GAAJ,EAAS;AACP,eAAOvB,MAAM,CAACuB,GAAD,CAAb;AACD;;AAED,oDAAsBC,KAAtB;;AAEA,UAAIA,KAAK,CAACC,SAAN,EAAJ,EAAuB;AACrB,cAAMC,kBAAkB,GAAIF,KAAD,IAAwC,CACjE,GAAGA,KAAK,CAACrB,WAAN,CAAkBwB,MAD4C,EAEjE,GAAG,sBAAQH,KAAK,CAACrB,WAAN,CAAkByB,QAA1B,EAAoCC,KAAK,IAC1CH,kBAAkB,CAACG,KAAK,CAACC,QAAN,EAAD,CADjB,CAF8D,CAAnE;;AAMA,eAAO9B,MAAM,CAAC0B,kBAAkB,CAACF,KAAD,CAAnB,CAAb;AACD;;AAED,aAAOzB,OAAO,CAACyB,KAAD,CAAd;AACD,KAlBD;AAmBD,GApEM,CAAP;AAqED,CAnFM","sourcesContent":["import { Span } from \"opentracing\"\nimport webpack from \"webpack\"\nimport { isEqual } from \"lodash\"\nimport flatMap from \"lodash/flatMap\"\n\nimport webpackConfig from \"../utils/webpack.config\"\nimport { store } from \"../redux\"\nimport mapTemplatesToStaticQueryHashes from \"../utils/map-templates-to-static-query-hashes\"\n\nimport { IProgram } from \"./types\"\n\nimport { reportWebpackWarnings } from \"../utils/webpack-error-utils\"\n\ninterface IWebpackCompilerWithParentCompilation extends webpack.Compiler {\n  parentCompilation?: webpack.compilation.Compilation\n}\n\nexport const buildProductionBundle = async (\n  program: IProgram,\n  parentSpan: Span\n): Promise<webpack.Stats> => {\n  const { directory } = program\n\n  const compilerConfig = await webpackConfig(\n    program,\n    directory,\n    `build-javascript`,\n    null,\n    { parentSpan }\n  )\n\n  return new Promise((resolve, reject) => {\n    const compiler = webpack(compilerConfig)\n\n    compiler.hooks.compilation.tap(`webpack-dep-tree-plugin`, compilation => {\n      // \"compilation\" callback gets called for child compilers.\n      // We only want to attach \"seal\" hook on main compilation\n      // so we ignore compilations that have parent.\n      // (mini-css-extract-plugin is one example of child compilations)\n      const compilationCompiler: IWebpackCompilerWithParentCompilation =\n        compilation.compiler\n      if (compilationCompiler.parentCompilation) {\n        return\n      }\n\n      compilation.hooks.seal.tap(`webpack-dep-tree-plugin`, () => {\n        const state = store.getState()\n        const mapOfTemplatesToStaticQueryHashes = mapTemplatesToStaticQueryHashes(\n          state,\n          compilation\n        )\n\n        mapOfTemplatesToStaticQueryHashes.forEach(\n          (staticQueryHashes, componentPath) => {\n            if (\n              !isEqual(\n                state.staticQueriesByTemplate.get(componentPath),\n                staticQueryHashes\n              )\n            ) {\n              store.dispatch({\n                type: `ADD_PENDING_TEMPLATE_DATA_WRITE`,\n                payload: {\n                  componentPath,\n                  pages: state.components.get(componentPath)?.pages ?? [],\n                },\n              })\n              store.dispatch({\n                type: `SET_STATIC_QUERIES_BY_TEMPLATE`,\n                payload: {\n                  componentPath,\n                  staticQueryHashes,\n                },\n              })\n            }\n          }\n        )\n      })\n    })\n\n    compiler.run((err, stats) => {\n      if (err) {\n        return reject(err)\n      }\n\n      reportWebpackWarnings(stats)\n\n      if (stats.hasErrors()) {\n        const flattenStatsErrors = (stats: webpack.Stats): Array<Error> => [\n          ...stats.compilation.errors,\n          ...flatMap(stats.compilation.children, child =>\n            flattenStatsErrors(child.getStats())\n          ),\n        ]\n        return reject(flattenStatsErrors(stats))\n      }\n\n      return resolve(stats)\n    })\n  })\n}\n"],"file":"build-javascript.js"}