{"version":3,"sources":["../../src/commands/build-html.ts"],"names":["devssrWebpackCompiler","devssrWebpackWatcher","needToRecompileSSRBundle","getDevSSRWebpack","process","env","gatsby_executing_command","Error","oldHash","newHash","runWebpack","compilerConfig","stage","directory","Bluebird","resolve","reject","GATSBY_EXPERIMENTAL_DEV_SSR","run","err","stats","hooks","invalid","tap","file","watch","ignored","emitter","emit","suspend","hash","restartWorker","require","doBuildRenderer","webpackConfig","hasErrors","reporter","panic","compilation","errors","buildRenderer","program","parentSpan","config","deleteRenderer","rendererPath","fs","remove","e","renderHTMLQueue","workerPool","activity","htmlComponentRendererPath","pages","envVars","NODE_ENV","gatsby_log_level","segments","map","pageSegment","renderHTML","paths","tick","length","BuildHTMLError","constructor","error","message","codeFrame","Object","getOwnPropertyNames","forEach","key","doBuildPages","pagePaths","telemetry","addSiteMeasurement","pagesCount","prettyError","stack","buildError","context","buildHTML","span"],"mappings":"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","sourcesContent":["import Bluebird from \"bluebird\"\nimport fs from \"fs-extra\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { createErrorFromString } from \"gatsby-cli/lib/reporter/errors\"\nimport telemetry from \"gatsby-telemetry\"\nimport { chunk } from \"lodash\"\nimport webpack from \"webpack\"\n\nimport { emitter } from \"../redux\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { structureWebpackErrors } from \"../utils/webpack-error-utils\"\n\nimport { IProgram, Stage } from \"./types\"\n\ntype IActivity = any // TODO\ntype IWorkerPool = any // TODO\n\nexport interface IWebpackWatchingPauseResume extends webpack.Watching {\n  suspend: () => void\n  resume: () => void\n}\n\nlet devssrWebpackCompiler: webpack.Compiler\nlet devssrWebpackWatcher: IWebpackWatchingPauseResume\nlet needToRecompileSSRBundle = true\nexport const getDevSSRWebpack = (): Record<\n  IWebpackWatchingPauseResume,\n  webpack.Compiler,\n  needToRecompileSSRBundle\n> => {\n  if (process.env.gatsby_executing_command !== `develop`) {\n    throw new Error(`This function can only be called in development`)\n  }\n\n  return {\n    devssrWebpackWatcher,\n    devssrWebpackCompiler,\n    needToRecompileSSRBundle,\n  }\n}\n\nlet oldHash = ``\nlet newHash = ``\nconst runWebpack = (\n  compilerConfig,\n  stage: Stage,\n  directory\n): Bluebird<webpack.Stats> =>\n  new Bluebird((resolve, reject) => {\n    if (!process.env.GATSBY_EXPERIMENTAL_DEV_SSR || stage === `build-html`) {\n      webpack(compilerConfig).run((err, stats) => {\n        if (err) {\n          return reject(err)\n        } else {\n          return resolve(stats)\n        }\n      })\n    } else if (\n      process.env.GATSBY_EXPERIMENTAL_DEV_SSR &&\n      stage === `develop-html`\n    ) {\n      devssrWebpackCompiler = webpack(compilerConfig)\n      devssrWebpackCompiler.hooks.invalid.tap(`ssr file invalidation`, file => {\n        needToRecompileSSRBundle = true\n      })\n      devssrWebpackWatcher = devssrWebpackCompiler.watch(\n        {\n          ignored: /node_modules/,\n        },\n        (err, stats) => {\n          needToRecompileSSRBundle = false\n          emitter.emit(`DEV_SSR_COMPILATION_DONE`)\n          devssrWebpackWatcher.suspend()\n\n          if (err) {\n            return reject(err)\n          } else {\n            newHash = stats.hash || ``\n\n            const {\n              restartWorker,\n            } = require(`../utils/dev-ssr/render-dev-html`)\n            // Make sure we use the latest version during development\n            if (oldHash !== `` && newHash !== oldHash) {\n              restartWorker(`${directory}/public/render-page.js`)\n            }\n\n            oldHash = newHash\n\n            return resolve(stats)\n          }\n        }\n      )\n    }\n  })\n\nconst doBuildRenderer = async (\n  { directory }: IProgram,\n  webpackConfig: webpack.Configuration,\n  stage: Stage\n): Promise<string> => {\n  const stats = await runWebpack(webpackConfig, stage, directory)\n  if (stats.hasErrors()) {\n    reporter.panic(structureWebpackErrors(stage, stats.compilation.errors))\n  }\n\n  // render-page.js is hard coded in webpack.config\n  return `${directory}/public/render-page.js`\n}\n\nexport const buildRenderer = async (\n  program: IProgram,\n  stage: Stage,\n  parentSpan?: IActivity\n): Promise<string> => {\n  const { directory } = program\n  const config = await webpackConfig(program, directory, stage, null, {\n    parentSpan,\n  })\n\n  return doBuildRenderer(program, config, stage)\n}\n\nconst deleteRenderer = async (rendererPath: string): Promise<void> => {\n  try {\n    await fs.remove(rendererPath)\n    await fs.remove(`${rendererPath}.map`)\n  } catch (e) {\n    // This function will fail on Windows with no further consequences.\n  }\n}\n\nconst renderHTMLQueue = async (\n  workerPool: IWorkerPool,\n  activity: IActivity,\n  htmlComponentRendererPath: string,\n  pages: Array<string>\n): Promise<void> => {\n  // We need to only pass env vars that are set programmatically in gatsby-cli\n  // to child process. Other vars will be picked up from environment.\n  const envVars = [\n    [`NODE_ENV`, process.env.NODE_ENV],\n    [`gatsby_executing_command`, process.env.gatsby_executing_command],\n    [`gatsby_log_level`, process.env.gatsby_log_level],\n  ]\n\n  const segments = chunk(pages, 50)\n\n  await Bluebird.map(segments, async pageSegment => {\n    await workerPool.renderHTML({\n      envVars,\n      htmlComponentRendererPath,\n      paths: pageSegment,\n    })\n\n    if (activity && activity.tick) {\n      activity.tick(pageSegment.length)\n    }\n  })\n}\n\nclass BuildHTMLError extends Error {\n  codeFrame = ``\n  context?: {\n    path: string\n  }\n\n  constructor(error: Error) {\n    super(error.message)\n\n    // We must use getOwnProperty because keys like `stack` are not enumerable,\n    // but we want to copy over the entire error\n    Object.getOwnPropertyNames(error).forEach(key => {\n      this[key] = error[key]\n    })\n  }\n}\n\nconst doBuildPages = async (\n  rendererPath: string,\n  pagePaths: Array<string>,\n  activity: IActivity,\n  workerPool: IWorkerPool\n): Promise<void> => {\n  telemetry.addSiteMeasurement(`BUILD_END`, {\n    pagesCount: pagePaths.length,\n  })\n\n  try {\n    await renderHTMLQueue(workerPool, activity, rendererPath, pagePaths)\n  } catch (error) {\n    const prettyError = await createErrorFromString(\n      error.stack,\n      `${rendererPath}.map`\n    )\n    const buildError = new BuildHTMLError(prettyError)\n    buildError.context = error.context\n    throw buildError\n  }\n}\n\nexport const buildHTML = async ({\n  program,\n  stage,\n  pagePaths,\n  activity,\n  workerPool,\n}: {\n  program: IProgram\n  stage: Stage\n  pagePaths: Array<string>\n  activity: IActivity\n  workerPool: IWorkerPool\n}): Promise<void> => {\n  const rendererPath = await buildRenderer(program, stage, activity.span)\n  await doBuildPages(rendererPath, pagePaths, activity, workerPool)\n  if (stage !== `develop-html`) {\n    await deleteRenderer(rendererPath)\n  }\n}\n"],"file":"build-html.js"}